!-----------------------------------------------------------------------------
! (C) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the Socrates thermodynamic kernel
!>
module set_thermodynamic_kernel_mod_test

  use pFUnit_Mod
  use constants_mod,                       only : r_def, i_def
  use get_unit_test_m3x3_dofmap_mod,       only : get_wtheta_m3x3_dofmap, &
                                                  get_w3_m3x3_dofmap
  use get_unit_test_m3x3_q3x3x3_sizes_mod, only : get_w3_m3x3_q3x3x3_size, &
                                                  get_wtheta_m3x3_q3x3x3_size

  implicit none

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_set_thermodynamic()

    use set_thermodynamic_kernel_mod, only: set_thermodynamic_code

    implicit none

    ! Input constants
    real(r_def), parameter :: gravity  = 9.80665_r_def
    real(r_def), parameter :: p_zero   = 100000.0_r_def
    real(r_def), parameter :: cp       = 1005.0_r_def
    real(r_def), parameter :: rd       = 287.05_r_def
    real(r_def), parameter :: kappa    = rd/cp

    ! Dofmap, cell numbers and layers
    integer(i_def) :: nlayers
    integer(i_def) :: ndf_w3, ndf_wtheta, ndf_flux
    integer(i_def) :: undf_w3, undf_wtheta, undf_flux
    integer(i_def) :: cells_w3, cells_wtheta, cells_flux
    integer(i_def) :: dim_space_w3, dim_space_wtheta, dim_space_flux
    integer(i_def) :: dim_space_diff_w3, dim_space_diff_wtheta, dim_space_diff_flux
    integer(i_def) :: nqp_h_w3, nqp_h_wtheta, nqp_h_flux
    integer(i_def) :: nqp_v_w3, nqp_v_wtheta, nqp_v_flux
    integer(i_def), allocatable :: map_w3(:,:), map_wtheta(:,:), map_flux(:,:)

    ! Input fields
    real(r_def), allocatable :: exner_w3(:)
    real(r_def), allocatable :: exner_wtheta(:)
    real(r_def), allocatable :: rho_wtheta(:)
    real(r_def), allocatable :: theta_wtheta(:)
    real(r_def), allocatable :: theta_w3(:)
    real(r_def), allocatable :: dz_wtheta(:)
    real(r_def), allocatable :: temperature_wtheta(:)
    real(r_def), allocatable :: moist_mass_fac(:)

    ! Output fields and expected results fields
    real(r_def), allocatable :: d_mass_wtheta(:), d_mass_wtheta_answer(:)
    real(r_def), allocatable :: layer_heat_capacity_wtheta(:), layer_heat_capacity_wtheta_answer(:)
    real(r_def), allocatable :: t_layer_boundaries(:), t_layer_boundaries_answer(:)

    integer(i_def) :: cell
    real(r_def), parameter :: tol = 1E-08_r_def

    ! Set up dofmap and field dimensions
    nlayers = 7

    call get_wtheta_m3x3_q3x3x3_size( ndf_wtheta, undf_wtheta, cells_wtheta,   &
                                      dim_space_wtheta, dim_space_diff_wtheta, &
                                      nqp_h_wtheta, nqp_v_wtheta, nlayers)

    call get_w3_m3x3_q3x3x3_size( ndf_w3, undf_w3, cells_w3,       &
                                  dim_space_w3, dim_space_diff_w3, &
                                  nqp_h_w3, nqp_v_w3, nlayers)

    call get_w3_m3x3_q3x3x3_size( ndf_flux, undf_flux, cells_flux,       &
                                  dim_space_flux, dim_space_diff_flux, &
                                  nqp_h_flux, nqp_v_flux, nlayers+1)


    call get_w3_m3x3_dofmap(map_w3, nlayers)
    call get_wtheta_m3x3_dofmap(map_wtheta, nlayers)
    call get_w3_m3x3_dofmap(map_flux, nlayers+1)


    ! Allocate the fields
    allocate(exner_w3(1:undf_w3))
    allocate(exner_wtheta(1:undf_wtheta))
    allocate(rho_wtheta(1:undf_wtheta))
    allocate(theta_wtheta(1:undf_wtheta))
    allocate(theta_w3(1:undf_w3))
    allocate(dz_wtheta(1:undf_wtheta))
    allocate(temperature_wtheta(1:undf_wtheta))
    allocate(moist_mass_fac(1:undf_wtheta))
    allocate(d_mass_wtheta(1:undf_wtheta))
    allocate(layer_heat_capacity_wtheta(1:undf_wtheta))
    allocate(t_layer_boundaries(1:undf_flux))

    ! Allocate the expected results fields
    allocate(d_mass_wtheta_answer(1:undf_wtheta))
    allocate(layer_heat_capacity_wtheta_answer(1:undf_wtheta))
    allocate(t_layer_boundaries_answer(1:undf_flux))

    ! Set up input fields
    exner_w3 = (/ &
    0.980226587516,0.912603821090,0.806594638135,0.664819293568,0.486376345906,0.262351027019,0.041414370423,&
    0.972304974452,0.903317670180,0.794263113760,0.649387629836,0.485611718436,0.257662163448,0.041417776659,&
    0.971832064752,0.901397239704,0.789491345969,0.646415151989,0.484729395979,0.257561485285,0.041020227334,&
    0.968608589780,0.898373380972,0.787039758307,0.646192918458,0.484727696453,0.258184628681,0.040903339580,&
    0.959732097734,0.893923243856,0.787406242373,0.649465562569,0.485872967659,0.259043693875,0.040719853625,&
    0.955311555978,0.891782584208,0.789728780156,0.656345315531,0.487885903135,0.260595467994,0.040845600114,&
    0.982886211960,0.915455823811,0.810156366315,0.667844238503,0.489721624678,0.263843619904,0.041314969854,&
    0.982222743288,0.914737984373,0.809189949162,0.666600545052,0.487922340814,0.263831139809,0.041608759533,&
    0.981676448942,0.914068674554,0.808314225779,0.665520748188,0.486649096639,0.263572300533,0.041860705778 &
    /)

    exner_wtheta = (/ &
    1.00453166909987,0.98255534262152,0.91699251467081,0.81279660064794,0.67293133272153,0.49622840693386,0.27511884394180,0.05020509976646,&
    1.00173848883725,0.97975887515138,0.91413632434428,0.80922798756483,0.66801326217946,0.49339175188866,0.27438353954087,0.05038450453863,&
    1.00086499964211,0.97883959891464,0.91308526543054,0.80765072394438,0.66542677983613,0.49224637292720,0.27397739555644,0.05021728644908,&
    1.00199644503675,0.97972497237134,0.91357219381064,0.80766843826923,0.66468200562647,0.49242450670892,0.27333450441727,0.05002574679192,&
    0.99929574767233,0.97735349436685,0.91203474142864,0.80674246146697,0.66395919811093,0.49334085031874,0.27302077132731,0.05006969428943,&
    0.99300848256090,0.97159098037611,0.90750129653628,0.80394735071791,0.66219120065528,0.49449067165570,0.27252647546566,0.05005708517199,&
    0.99418177645046,0.97251043636276,0.90807962498777,0.80340283864977,0.66008646608123,0.49536746700306,0.27214506923648,0.05000972470844,&
    0.99684797974261,0.97465961034499,0.90785137923060,0.80066102695359,0.65728417460235,0.49504236912185,0.27172145401105,0.05020628974263,&
    0.99671448817810,0.97421915033527,0.90604597941979,0.79605807944551,0.65393487589611,0.49418382532426,0.27156872106414,0.04997340973073 &
    /)

    theta_wtheta = (/ &
    290.94625263546800,291.48367321516900,303.30717674338200,319.64777413706000,327.93017906458200,416.97219661014900,856.11926273516000,4363.87910564705000,&
    290.93694816378100,291.59853447347900,302.09760598275500,316.92821479518600,324.75017902399600,422.98660118786600,850.17933837473400,4361.87417310947000,&
    290.13260092834400,291.29986072244100,299.94701360944200,315.14187878009400,322.56854356678300,427.92762358395700,829.22479122571400,4415.45990106824000,&
    286.52567100690500,288.63653144435700,297.68321396648100,313.95344141442300,321.99480671229500,432.43532072540500,806.41112521020300,4402.60489439269000,&
    286.24303699757700,288.59960659597000,297.18467127113400,311.68362279877700,321.27809094292900,437.32313166213200,789.40385975358000,4421.29288001261000,&
    286.61099134998400,289.31756533354700,299.39872142486600,309.44849766575600,319.64871765413000,442.45665942708100,780.74222788113800,4396.75937253016000,&
    284.20684434366400,285.94557130988000,297.30167283514900,304.81667130727100,322.99714653871200,439.71050527401900,776.19435364688700,4365.73082485589000,&
    280.71118240372800,280.81655058291800,286.11731715363600,303.79972440557100,333.01337463799200,435.62593805742600,777.64608641828400,4364.54141264416000,&
    278.42688907025200,278.53704430490800,280.29178875832900,296.89424686806800,350.28082591928800,434.52501495200900,780.48558520066900,4284.47763218917000 &
    /)

    theta_w3 = (/ &
    291.708533443875,304.297015763628,320.404855531808,328.036118629529,424.743893707652,891.582088286074,5037.449530300880,&
    291.795562384844,302.729849555696,317.641137618862,325.350782665526,431.029491181991,892.636361459074,5008.704373902060,&
    291.531615758877,300.677029991086,315.983879842544,323.343617927638,437.600747646651,879.471050803523,5039.115328225920,&
    289.257755869817,298.731282389023,314.728366759445,323.368089850727,442.000215023754,860.906885871471,5073.428991722930,&
    288.938150467532,297.381512524974,312.255707069711,322.622584457335,447.823556481041,841.443919007942,5052.050663271340,&
    289.355092206049,299.921570135103,310.122698597775,321.886539065099,450.263400530359,831.946225725650,5021.980027285390,&
    286.227321651563,297.720223678128,305.227220963883,326.521107337042,445.716133769610,828.701759826497,5071.421808086690,&
    280.816550582918,287.020984263012,304.242977260155,337.975164069991,441.580590936904,830.595814023215,5028.281709226450,&
    278.541746232636,281.127192267224,298.035861183837,355.367721068474,441.344867157689,833.207607339506,4976.867089739300 &
    /)
    rho_wtheta = (/ &
    1.19038370633384,1.12644992278254,0.92159887963622,0.64909560563380,0.39495025190304,0.14519793263844,0.01659254193908,0.00004969075003,&
    1.18333159990702,1.11883530861652,0.91697794693056,0.64710866564960,0.39133117090749,0.14101732381790,0.01655942622658,0.00004966157140,&
    1.19038370633384,1.12644992278254,0.92159887963622,0.64909560563380,0.39495025190304,0.14519793263844,0.01659254193908,0.00004969075003,&
    1.18333159990702,1.11883530861652,0.91697794693056,0.64710866564960,0.39133117090749,0.14101732381790,0.01655942622658,0.00004966157140,&
    1.18406772201449,1.11740575586039,0.91808319921992,0.64701113159382,0.39005605031508,0.13854701866294,0.01677916736870,0.00004848132853,&
    1.20660028366959,1.13413304361924,0.92714470845984,0.65041284980086,0.38980322468449,0.13731693130990,0.01709519187886,0.00004804879013,&
    1.21095295030077,1.13753618361082,0.93487211605929,0.65635577450660,0.39035574107431,0.13636433036292,0.01735889605438,0.00004772619281,&
    1.12886321980649,1.06221563386957,0.87553253512945,0.63584249447069,0.38429858668093,0.13576642971164,0.01745425889206,0.00004806168545,&
    1.22020357582255,1.14880902096142,0.93424785213067,0.66793663926059,0.38287352307309,0.13709406481582,0.01744975140650,0.00004829772890 &
    /)
    dz_wtheta = (/ &
    9.99999084315741,133.33188249062300,266.66779288952400,399.99975911498700,537.75180772696700,816.05998241319700,2114.88800000004000,7406.38799999980000,&
    9.99983307887566,133.32985793326300,266.66422460387500,399.99560893258000,537.74849507354200,816.05967941105300,2114.88800000015000,7406.38799999980000,&
    9.99961957051046,133.32711802606000,266.65939551319200,399.98999233983900,537.74401193934900,816.05926934736300,2114.88800000027000,7406.38799999992000,&
    9.98540878515366,133.14475384892400,266.33797839069000,399.61616023810500,537.44562116083900,816.03197610694000,2114.88800000027000,7406.38800000015000,&
    9.83719855305941,131.24280147066400,262.98578460606600,395.71730868177500,534.33357876397000,815.74732347530500,2114.88800000027000,7406.38800000004000,&
    9.63050154079792,128.59029989654600,258.31074679123900,390.27989078970000,529.99346097216200,815.35034111038800,2114.88800000027000,7406.38799999969000,&
    9.61453895174054,128.38545517184700,257.94970767123800,389.85997534762800,529.65828671907400,815.31968335542500,2114.88800000027000,7406.38799999957000,&
    9.68870508730618,129.33721441286600,259.62718469366200,391.81100632048300,531.21558917498300,815.46212686522600,2114.88800000027000,7406.38799999992000,&
    9.73426949807694,129.92193341876400,260.65775277721600,393.00963391603600,532.17232729174400,815.54963789110500,2114.88800000027000,7406.38800000015000 &
    /)

    temperature_wtheta = (/ &
    0.00000000000000_r_def,   286.39883654976256_r_def,   278.13041398143469_r_def,   259.80861516500590_r_def,   220.67448392958613_r_def,   206.91344560363177_r_def,   235.53455354104881_r_def,   219.08897830634669_r_def, &
    0.00000000000000_r_def,   285.69625397763230_r_def,   276.15839308026261_r_def,   256.46719272239716_r_def,   216.93743326585172_r_def,   208.69810112253617_r_def,   233.27521599456668_r_def,   219.77085419978903_r_def, &
    0.00000000000000_r_def,   285.13583712400214_r_def,   273.87721065180085_r_def,   254.52457108356430_r_def,   214.64575000815603_r_def,   210.64580932361787_r_def,   227.18885172428418_r_def,   221.73241458622215_r_def, &
    0.00000000000000_r_def,   282.78441361616206_r_def,   271.95511876167438_r_def,   253.57027953564830_r_def,   214.02416551566421_r_def,   212.94176048652389_r_def,   220.41998634114861_r_def,   220.24359948762140_r_def, &
    0.00000000000000_r_def,   282.06384214258287_r_def,   271.04273878355889_r_def,   251.44842292749126_r_def,   213.31553608739341_r_def,   215.74935974921391_r_def,   215.52365558418569_r_def,   221.37278371273715_r_def, &
    0.00000000000000_r_def,   281.09834196936572_r_def,   271.70471460606677_r_def,   248.78028420786723_r_def,   211.66856817494590_r_def,   218.79069852791872_r_def,   212.77293116463807_r_def,   220.08894569634867_r_def, &
    0.00000000000000_r_def,   278.08504397681099_r_def,   269.97358536407410_r_def,   244.89058745362672_r_def,   213.20603074784231_r_def,   217.81828185513950_r_def,   211.23745620946283_r_def,   218.32899913990514_r_def, &
    0.00000000000000_r_def,   273.70056100839975_r_def,   259.75199948288355_r_def,   243.24059045187278_r_def,   218.88442438397396_r_def,   215.65330671892843_r_def,   211.30311615420760_r_def,   219.12743076789047_r_def, &
    0.00000000000000_r_def,   271.35612463620419_r_def,   253.95723731767976_r_def,   236.34506555313783_r_def,   229.06085339566562_r_def,   214.73524443165661_r_def,   211.95547074782371_r_def,   214.10995107971758_r_def  &
    /)

    moist_mass_fac = 1.0_r_def

    ! Set all output fields to 0.0
    d_mass_wtheta = 0.0_r_def
    layer_heat_capacity_wtheta = 0.0_r_def
    t_layer_boundaries = 0.0_r_def

    ! Call kernel code on all columns
    do cell=1_i_def,cells_wtheta
      call set_thermodynamic_code( nlayers, &
                                   exner_w3, &
                                   exner_wtheta, &
                                   theta_wtheta, &
                                   theta_w3, &
                                   rho_wtheta, &
                                   dz_wtheta, &
                                   temperature_wtheta, &
                                   moist_mass_fac, &
                                   d_mass_wtheta, &
                                   layer_heat_capacity_wtheta, &
                                   t_layer_boundaries, &
                                   p_zero, &
                                   kappa, &
                                   gravity, &
                                   cp, &
                                   ndf_w3, &
                                   undf_w3, &
                                   map_w3(:,cell), &
                                   ndf_wtheta, &
                                   undf_wtheta, &
                                   map_wtheta(:,cell), &
                                   ndf_flux, &
                                   undf_flux, &
                                   map_flux(:,cell) )
    end do

    ! Set up expected fields

    d_mass_wtheta_answer = (/ &
    0.00000000000000_r_def,   161.45617574741505_r_def,   245.76072503024989_r_def,   259.63807948258182_r_def,   212.38521519281858_r_def,   118.49022072986918_r_def,   35.09136634638389_r_def,   0.14687311980221_r_def, &
    0.00000000000000_r_def,   160.36232952446323_r_def,   244.52520315364563_r_def,   258.84062588046072_r_def,   210.43773740811048_r_def,   115.07854896159552_r_def,   35.02132978482859_r_def,   0.14691544760249_r_def, &
    0.00000000000000_r_def,   161.45039512002984_r_def,   245.75299066488697_r_def,   259.63174065841304_r_def,   212.38212964406193_r_def,   118.49011438373054_r_def,   35.09136634638389_r_def,   0.14203720314863_r_def, &
    0.00000000000000_r_def,   160.13908977209439_r_def,   244.22605477108118_r_def,   258.59507689202292_r_def,   210.31922024222695_r_def,   115.07464137722855_r_def,   35.02132978482859_r_def,   0.14062524393089_r_def, &
    0.00000000000000_r_def,   157.64360199545331_r_def,   241.44282297464088_r_def,   256.03351978277715_r_def,   208.42003339710391_r_def,   113.01935799795683_r_def,   35.48605914398058_r_def,   0.13842897392013_r_def, &
    0.00000000000000_r_def,   156.76078815710821_r_def,   239.49145416297870_r_def,   253.84304984772280_r_def,   206.59316659209799_r_def,   111.96140361980724_r_def,   36.15441412343489_r_def,   0.13993143800750_r_def, &
    0.00000000000000_r_def,   156.97998143403481_r_def,   241.14998193780775_r_def,   255.88686188900465_r_def,   206.75514154384473_r_def,   111.18052156097292_r_def,   36.71211850513191_r_def,   0.14564264033373_r_def, &
    0.00000000000000_r_def,   147.67551793690109_r_def,   227.31205114009208_r_def,   249.13008954649013_r_def,   204.14539839940699_r_def,   110.71237911033768_r_def,   36.91380205755377_r_def,   0.14930095976190_r_def, &
    0.00000000000000_r_def,   160.43831593740435_r_def,   243.51893854722948_r_def,   262.50553416026378_r_def,   203.75469067320228_r_def,   111.80701327798943_r_def,   36.90426898601072_r_def,   0.15249018264239_r_def  &
    /)
    layer_heat_capacity_wtheta_answer = (/ &
    0.00000000000000_r_def, 162263.45662615212495_r_def, 246989.52865540113999_r_def, 260936.26987999473931_r_def, 213447.14126878266688_r_def, 119082.67183351852873_r_def, 35266.82317811581015_r_def, 147.60748540121887_r_def, &
    0.00000000000000_r_def, 161164.14117208553944_r_def, 245747.82916941386065_r_def, 260134.82900986302411_r_def, 211489.92609515102231_r_def, 115653.94170640349330_r_def, 35196.43643375273678_r_def, 147.65002484049995_r_def, &
    0.00000000000000_r_def, 162257.64709562997450_r_def, 246981.75561821140582_r_def, 260929.89936170511646_r_def, 213444.04029228223953_r_def, 119082.56495564919896_r_def, 35266.82317811581015_r_def, 142.74738916437363_r_def, &
    0.00000000000000_r_def, 160939.78522095485823_r_def, 245447.18504493657383_r_def, 259888.05227648303844_r_def, 211370.81634343808400_r_def, 115650.01458411468775_r_def, 35196.43643375273678_r_def, 141.32837015054093_r_def, &
    0.00000000000000_r_def, 158431.82000543057802_r_def, 242650.03708951408044_r_def, 257313.68738169103744_r_def, 209462.13356408942491_r_def, 113584.45478794661176_r_def, 35663.48943970048276_r_def, 139.12111878972976_r_def, &
    0.00000000000000_r_def, 157544.59209789373563_r_def, 240688.91143379360437_r_def, 255112.26509696140420_r_def, 207626.13242505848757_r_def, 112521.21063790627522_r_def, 36335.18619405206118_r_def, 140.63109519753652_r_def, &
    0.00000000000000_r_def, 157764.88134120497853_r_def, 242355.73184749679058_r_def, 257166.29619844967965_r_def, 207788.91725156395114_r_def, 111736.42416877778305_r_def, 36895.67909765757213_r_def, 146.37085353540343_r_def, &
    0.00000000000000_r_def, 148413.89552658560569_r_def, 228448.61139579254086_r_def, 250375.73999422258930_r_def, 205166.12539140402805_r_def, 111265.94100588936999_r_def, 37098.37106784153730_r_def, 150.04746456070842_r_def, &
    0.00000000000000_r_def, 161240.50751709137694_r_def, 244736.53323996561812_r_def, 263818.06183106510434_r_def, 204773.46412656828761_r_def, 112366.04834437937825_r_def, 37088.79033094077022_r_def, 153.25263355560637_r_def  &
    /)
    t_layer_boundaries_answer = (/ &
    292.26471699146350_r_def,   277.70262234472284_r_def,   258.43682202450873_r_def,   218.08475224842550_r_def,   206.58538400007819_r_def,   233.90748565405374_r_def,   208.62280047048444_r_def,   219.08897830634669_r_def, &
    291.44275861844653_r_def,   273.46123635090771_r_def,   252.29064733259293_r_def,   211.27877382095539_r_def,   209.31296152862160_r_def,   229.99862594121078_r_def,   207.44941245720838_r_def,   219.77085419978903_r_def, &
    290.38355852811947_r_def,   271.02944366481097_r_def,   249.46654701619991_r_def,   209.01422751235805_r_def,   212.11794745870066_r_def,   226.51786587187598_r_def,   206.70564441127499_r_def,   221.73241458622215_r_def, &
    287.09768454033110_r_def,   268.37223679596354_r_def,   247.70373429488973_r_def,   208.95817494250514_r_def,   214.24975158358302_r_def,   222.27292919055253_r_def,   207.52020470241587_r_def,   220.24359948762140_r_def, &
    286.04146137588396_r_def,   265.83622916436252_r_def,   245.87210003587643_r_def,   209.53226080042077_r_def,   217.58534988645079_r_def,   217.97073801624356_r_def,   205.71875935856951_r_def,   221.37278371273715_r_def, &
    284.60715006648024_r_def,   267.46483187720514_r_def,   244.91282437238624_r_def,   211.26871732297514_r_def,   219.67715936221248_r_def,   216.80141886232559_r_def,   205.12578059625412_r_def,   220.08894569634867_r_def, &
    282.55326227696060_r_def,   272.54970286739990_r_def,   247.28178031227435_r_def,   218.06524666453333_r_def,   218.27682572784943_r_def,   218.64768291625296_r_def,   209.52564618276665_r_def,   218.32899913990514_r_def, &
    279.82637639596942_r_def,   262.54901176385465_r_def,   246.19037023416240_r_def,   225.29441834880345_r_def,   215.45703842852254_r_def,   219.13704228668939_r_def,   209.22055936532342_r_def,   219.12743076789047_r_def, &
    277.51210078758595_r_def,   256.96957142523024_r_def,   240.90661751182415_r_def,   236.50457447377448_r_def,   214.78008646811395_r_def,   219.61044292072438_r_def,   208.33517963247141_r_def,   214.10995107971758_r_def  &
    /)

    ! Compare kernel output with expected output based on a tolerance
    @assertEqual(d_mass_wtheta, d_mass_wtheta_answer, tol)
    @assertEqual(layer_heat_capacity_wtheta, layer_heat_capacity_wtheta_answer, tol)
    @assertEqual(t_layer_boundaries, t_layer_boundaries_answer, tol)

    deallocate(map_w3)
    deallocate(map_wtheta)
    deallocate(map_flux)
    deallocate(exner_w3)
    deallocate(exner_wtheta)
    deallocate(rho_wtheta)
    deallocate(theta_wtheta)
    deallocate(theta_w3)
    deallocate(dz_wtheta)
    deallocate(temperature_wtheta)
    deallocate(moist_mass_fac)
    deallocate(d_mass_wtheta)
    deallocate(layer_heat_capacity_wtheta)
    deallocate(t_layer_boundaries)
    deallocate(d_mass_wtheta_answer)
    deallocate(layer_heat_capacity_wtheta_answer)
    deallocate(t_layer_boundaries_answer)

  end subroutine test_set_thermodynamic

end module set_thermodynamic_kernel_mod_test
