!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the calculation of flux through a cell edge for the split 1D advection
!> scheme.
!>
module conservative_flux_kernel_mod_test

  implicit none

contains

  @test
  subroutine conservative_flux_kernel_test()

    use pFUnit_Mod
    use constants_mod,              only : r_def
    use conservative_flux_kernel_mod, only : conservative_flux_code
    use configuration_mod,            only : x_direction, y_direction

    implicit none

    real(kind=r_def), allocatable :: dep_pts(:), flux(:), rho(:)
    real(kind=r_def), allocatable :: a0_coeffs(:), a1_coeffs(:), a2_coeffs(:)
    real(kind=r_def) :: tol
    real(kind=r_def) :: deltaT
    real(kind=r_def) :: fr

    integer, pointer     :: map_w3(:) => null()
    integer,allocatable  :: stencil_map(:)

    integer :: undf_w2, undf_w3, ndf_w2, ndf_w3
    integer :: nlayers
    integer :: map_w2(1:2)
    integer :: stencil_length
    integer :: ii

    tol = 1.0e-6_r_def
    deltaT = 1.0_r_def
    ndf_w2 = 2
    undf_w2 = 11
    undf_w3 = 10
    ndf_w3 = 1

    nlayers = 1

    map_w2 = (/ 1,2 /)

    allocate(dep_pts(1:undf_w2))
    allocate(flux(1:undf_w2))
    allocate(rho(1:undf_w3))
    allocate(a0_coeffs(1:undf_w3))
    allocate(a1_coeffs(1:undf_w3))
    allocate(a2_coeffs(1:undf_w3))

    flux(:) = 0.0_r_def
    dep_pts(:) = 3.34_r_def

    stencil_length = 9
    allocate(stencil_map(1:stencil_length))
    do ii=1,stencil_length
      stencil_map(ii) = ii
    end do

    a0_coeffs(:) = 1.0_r_def
    a1_coeffs(:) = 0.0_r_def
    a2_coeffs(:) = 0.0_r_def
    rho(:) = 1.0_r_def

    call conservative_flux_code( nlayers,              &
                                 undf_w3,              &
                                 ndf_w3,               &
                                 map_w3,               &
                                 rho,                  &
                                 a0_coeffs,            &
                                 a1_coeffs,            &
                                 a2_coeffs,            &
                                 undf_w2,              &
                                 ndf_w2,               &
                                 map_w2,               &
                                 flux,                 &
                                 dep_pts,              &
                                 stencil_length,       &
                                 stencil_map,          &
                                 x_direction,          &
                                 deltaT )
    @assertEqual(3.34_r_def, flux(1), tol)


    fr = 5.0_r_def/6.0_r_def
    a0_coeffs(:) = (/ 1.0_r_def,1.0_r_def,3.0_r_def,3.0_r_def,7.0_r_def,7.0_r_def,13.0_r_def,13.0_r_def,21.0_r_def /)
    a1_coeffs(:) = (/ 1.0_r_def,-1.0_r_def,3.0_r_def,-3.0_r_def,5.0_r_def,-5.0_r_def,7.0_r_def,-7.0_r_def,9.0_r_def /)
    a2_coeffs(:) = 1.0_r_def
    rho(:) = (/ 1.0_r_def+fr,fr,4.0_r_def+fr,1.0_r_def+fr, 9.0_r_def+fr,4.0_r_def+fr,16.0_r_def+fr,9.0_r_def+fr,25.0_r_def+fr /)

    dep_pts(:) = 1.0_r_def
    call conservative_flux_code( nlayers,              &
                                 undf_w3,              &
                                 ndf_w3,               &
                                 map_w3,               &
                                 rho,                  &
                                 a0_coeffs,            &
                                 a1_coeffs,            &
                                 a2_coeffs,            &
                                 undf_w2,              &
                                 ndf_w2,               &
                                 map_w2,               &
                                 flux,                 &
                                 dep_pts,              &
                                 stencil_length,       &
                                 stencil_map,          &
                                 x_direction,          &
                                 deltaT )
    @assertEqual(fr, flux(1), tol)

    dep_pts(:) = -1.0_r_def
    call conservative_flux_code( nlayers,              &
                                 undf_w3,              &
                                 ndf_w3,               &
                                 map_w3,               &
                                 rho,                  &
                                 a0_coeffs,            &
                                 a1_coeffs,            &
                                 a2_coeffs,            &
                                 undf_w2,              &
                                 ndf_w2,               &
                                 map_w2,               &
                                 flux,                 &
                                 dep_pts,              &
                                 stencil_length,       &
                                 stencil_map,          &
                                 x_direction,          &
                                 deltaT )
    @assertEqual(-(1.0_r_def+fr), flux(1), tol)

    dep_pts(:) = -2.0_r_def
    call conservative_flux_code( nlayers,              &
                                 undf_w3,              &
                                 ndf_w3,               &
                                 map_w3,               &
                                 rho,                  &
                                 a0_coeffs,            &
                                 a1_coeffs,            &
                                 a2_coeffs,            &
                                 undf_w2,              &
                                 ndf_w2,               &
                                 map_w2,               &
                                 flux,                 &
                                 dep_pts,              &
                                 stencil_length,       &
                                 stencil_map,          &
                                 x_direction,          &
                                 deltaT )
    @assertEqual(-(1.0_r_def+fr+4.0_r_def+fr), flux(1), tol)

  end subroutine conservative_flux_kernel_test

end module conservative_flux_kernel_mod_test
