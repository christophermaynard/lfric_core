!-----------------------------------------------------------------------------
! (c) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

! Test the level_insert_kernel

module sci_level_insert_kernel_mod_test

  use constants_mod, only : r_def, i_def
  use funit

  implicit none

  private
  public:: test_of_sci_level_insert

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_of_sci_level_insert( )

    use sci_level_insert_kernel_mod, only : level_insert_code

    implicit none

    real(kind=r_def), parameter :: tol = 1.0e-14_r_def

    integer(kind=i_def) :: ndata_in, nlayers, i, ndata_out, layer, multi

    integer(kind=i_def)              :: ndf_in, undf_in
    integer(kind=i_def), allocatable :: map_in(:)
    integer(kind=i_def)              :: ndf_out, undf_out
    integer(kind=i_def), allocatable :: map_out(:)

    real(kind=r_def),    allocatable :: input_field(:),         &
                                        answer_output_field(:), &
                                        output_field(:)

    nlayers = 2_i_def
    ndata_in = 1_i_def
    layer = 1_i_def
    multi = 3_i_def

    ndf_in  = 1_i_def
    undf_in = ndata_in
    allocate(map_in(ndf_in))
    do i=1_i_def, ndf_in
      map_in(i) = i
    end do

    ndata_out = 5_i_def

    ndf_out  = 1_i_def
    undf_out = nlayers * ndata_out
    allocate(map_out(ndf_out))
    do i=1_i_def, ndf_out
      map_out(i) = i
    end do

    ! Set input data
    allocate( input_field(undf_in) )
    allocate( answer_output_field(undf_out) )
    allocate( output_field(undf_out) )

    input_field(map_in(1)+0) =  1.0_r_def

    ! Set answers
    answer_output_field(:) = 0.0_r_def
    answer_output_field(map_out(1)+multi*nlayers+layer) = 1.0_r_def
    output_field(:) = 0.0_r_def

    call level_insert_code(nlayers,                    &
                           output_field(:),            &
                           input_field(:),             &
                           layer,                      &
                           multi,                      &
                           ndf_out, undf_out, map_out, &
                           ndf_in, undf_in, map_in)

    @assertEqual( answer_output_field(:), output_field(:), tol )

    deallocate( input_field, answer_output_field, &
                output_field )

  end subroutine test_of_sci_level_insert

end module sci_level_insert_kernel_mod_test
