!-----------------------------------------------------------------------------
! (C) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test lumping of a W2 mass matrix along the domain edge

module sci_edge_lump_w2_mass_matrix_kernel_mod_test

  use constants_mod, only : i_def, r_def
  use funit

  implicit none

  private
  public :: test_edge_lump_w2_mass_matrix_kernel

  @TestCase
  type, extends(TestCase), public :: edge_lump_w2_mass_matrix_test_type
    private
  contains
    procedure test_edge_lump_w2_mass_matrix_kernel
  end type edge_lump_w2_mass_matrix_test_type

  contains


  @Test
  subroutine test_edge_lump_w2_mass_matrix_kernel( this )

    use sci_edge_lump_w2_mass_matrix_kernel_mod, only : edge_lump_w2_mass_matrix_code

    implicit none

    class(edge_lump_w2_mass_matrix_test_type), intent(inout) :: this

    real(kind=r_def), parameter :: tol = 1.0e-9_r_def

    ! Mesh
    integer(kind=i_def), parameter :: ncell_2d = 1
    integer(kind=i_def), parameter :: cell = 1
    integer(kind=i_def), parameter :: nlayers = 1
    integer(kind=i_def), parameter :: ncell = ncell_2d*nlayers

    ! Function spaces
    integer(kind=i_def), parameter :: ndf_w2 = 2
    integer(kind=i_def), parameter :: undf_w2 = ndf_w2*ncell
    integer(kind=i_def)            :: map_w2(ndf_w2)

    ! Fields
    real(kind=r_def) :: dummy_field(undf_w2)

    ! Operators
    real(kind=r_def) :: mm_w2(ncell, ndf_w2, ndf_w2)

    ! Stencil maps
    integer(kind=i_def) :: smap_sizes(4)
    integer(kind=i_def), parameter :: max_length = 2
    integer(kind=i_def) :: smap(ndf_w2, max_length, 4)

    ! Local terms
    real(kind=r_def) :: mm(ndf_w2, ndf_w2)
    real(kind=r_def) :: answer(ndf_w2, ndf_w2)

    ! Default mass matrix
    mm(1, : ) = (/ 2.0_r_def, 1.0_r_def /)
    mm(2, : ) = (/ 1.5_r_def, 5.0_r_def /)

    ! Dof map
    map_w2 = (/ 1, 2 /)

    ! Stencil map shouldn't be used, so set to 0
    smap(:,:,:) = 0

    ! Dummy field shouldn't be used, so set to 0
    dummy_field(:) = 0.0_r_def

    ! Test with smap_sizes = 2 (all directions have neighbours)
    ! should leave mass matrix unchanged
    smap_sizes(:) = 2
    mm_w2(1,:,:) = mm

    call edge_lump_w2_mass_matrix_code(cell,         &
                                       nlayers,      &
                                       ncell,        &
                                       mm_w2,        &
                                       dummy_field,  &
                                       smap_sizes,   &
                                       max_length,   &
                                       smap,         &
                                       ndf_w2,       &
                                       undf_w2,      &
                                       map_w2 )

    @assertEqual(mm, mm_w2(1,:,:), tol)

    ! Test with smap_sizes(i) = 1 (one direction does not have a neighbour)
    ! mass matrix will be lumped
    smap_sizes(:) = 2
    smap_sizes(3) = 1
    mm_w2(1,:,:) = mm

    call edge_lump_w2_mass_matrix_code(cell,         &
                                       nlayers,      &
                                       ncell,        &
                                       mm_w2,        &
                                       dummy_field,  &
                                       smap_sizes,   &
                                       max_length,   &
                                       smap,         &
                                       ndf_w2,       &
                                       undf_w2,      &
                                       map_w2 )

    ! Lumped mass matrix
    mm(1,:) = (/ 3.0_r_def, 0.0_r_def /)
    mm(2,:) = (/ 0.0_r_def, 6.5_r_def /)
    @assertEqual(mm, mm_w2(1,:,:), tol)

  end subroutine test_edge_lump_w2_mass_matrix_kernel

end module sci_edge_lump_w2_mass_matrix_kernel_mod_test
